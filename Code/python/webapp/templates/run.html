<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <title>{{ title }}</title>
  <style>
    :root { color-scheme: light; }
    html, body { height: 100%; margin: 0; padding: 0; }
    body { 
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Helvetica Neue', 'Microsoft YaHei', Arial, sans-serif; 
      background: linear-gradient(135deg, #f5f5f5 0%, #e8e8e8 100%); 
      color: #1a1a1a; 
      display: flex;
      flex-direction: column;
    }
    
    .header {
      background: #ffffff;
      border-bottom: 1px solid #d0d0d0;
      padding: 20px 0;
      text-align: center;
    }
    
    .header h1 {
      margin: 0;
      font-size: 2.5em;
      background: linear-gradient(135deg, #3a86ff, #7a5cff);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    
    .header p {
      margin: 10px 0 0 0;
      color: #666666;
      font-size: 1.1em;
    }
    
    .main-content {
      flex: 1;
      display: flex;
      flex-direction: column;
      padding: 20px;
      max-width: 1200px;
      margin: 0 auto;
      width: 100%;
    }
    
    .control-panel {
      background: #ffffff;
      border: 1px solid #d0d0d0;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 20px;
      display: flex;
      gap: 15px;
      align-items: center;
      flex-wrap: wrap;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    .control-btn {
      background: #e3f2fd;
      color: #1976d2;
      border: 1px solid #90caf9;
      padding: 10px 20px;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      font-size: 14px;
    }
    
    .control-btn:hover {
      background: #bbdefb;
      border-color: #64b5f6;
      transform: translateY(-1px);
      box-shadow: 0 4px 8px rgba(25, 118, 210, 0.15);
    }
    
    .control-btn:disabled {
      background: #f5f5f5;
      color: #999;
      border-color: #e0e0e0;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }
    
    .control-btn.danger {
      background: #fff3e0;
      color: #e65100;
      border-color: #ffcc80;
    }
    
    .control-btn.danger:hover {
      background: #ffe0b2;
      border-color: #ffb74d;
      box-shadow: 0 4px 8px rgba(230, 81, 0, 0.15);
    }
    
    #btn-return-selection:hover {
      background: #f5f5f5 !important;
      border-color: #999999 !important;
      color: #1a1a1a !important;
    }
    
    .status-indicator {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 16px;
      background: #f5f5f5;
      border-radius: 8px;
      border: 1px solid #d0d0d0;
    }
    
    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #999;
    }
    
    .status-dot.running {
      background: #4caf50;
      animation: pulse 2s infinite;
    }
    
    .status-dot.stopped {
      background: #ff6b6b;
    }
    
    @keyframes pulse {
      0% { opacity: 1; }
      50% { opacity: 0.5; }
      100% { opacity: 1; }
    }
    
    .output-container {
      /* å›ºå®šå¤§å°çš„è¿è¡Œè¾“å‡ºçª—å£ï¼Œé«˜åº¦å›ºå®šï¼Œå†…å®¹è¶…å‡ºæ»šåŠ¨æŸ¥çœ‹ */
      background: #ffffff;
      border: 1px solid #d0d0d0;
      border-radius: 12px;
      padding: 20px;
      display: flex;
      flex-direction: column;
      height: 50vh;
      max-height: 50vh;
      min-height: 50vh;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    .output-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
      padding-bottom: 10px;
      border-bottom: 1px solid #e0e0e0;
    }
    
    .output-title {
      font-size: 1.2em;
      font-weight: 600;
      color: #1a1a1a;
    }
    
    .clear-btn {
      background: none;
      border: 1px solid #d0d0d0;
      color: #666666;
      padding: 6px 12px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 12px;
      transition: all 0.3s ease;
    }
    
    .clear-btn:hover {
      border-color: #ff6b6b;
      color: #ff6b6b;
    }
    
    .output-content {
      /* å†…å®¹è¶…å‡ºæ»šåŠ¨æŸ¥çœ‹ï¼Œå›ºå®šé«˜åº¦å¡«å……å®¹å™¨å‰©ä½™ç©ºé—´ */
      flex: 1;
      background: #f8f8f8;
      border: 1px solid #e0e0e0;
      border-radius: 8px;
      padding: 15px;
      font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
      font-size: 13px;
      line-height: 1.4;
      color: #1a1a1a;
      overflow-y: auto;
      white-space: pre-wrap;
      word-wrap: break-word;
    }
    
    .input-container {
      margin-top: 15px;
      display: flex;
      gap: 10px;
      align-items: center;
    }
    
    .input-field {
      flex: 1;
      background: #ffffff;
      border: 1px solid #d0d0d0;
      color: #1a1a1a;
      padding: 10px 15px;
      border-radius: 8px;
      font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
      font-size: 13px;
    }
    
    .input-field:focus {
      outline: none;
      border-color: #3a86ff;
    }
    
    .send-btn {
      background: #3a86ff;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s ease;
    }
    
    .send-btn:hover {
      background: #2a6bcc;
    }
    
    .send-btn:disabled {
      background: #e0e0e0;
      color: #999;
      cursor: not-allowed;
    }
    
    .back-btn {
      position: absolute;
      top: 20px;
      left: 20px;
      background: none;
      border: 1px solid #d0d0d0;
      color: #666666;
      padding: 8px 16px;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    
    .back-btn:hover {
      border-color: #3a86ff;
      color: #3a86ff;
    }
    
    .task-info {
      background: #ffffff;
      border: 1px solid #d0d0d0;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 20px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.08);
    }
    
    .task-title {
      font-size: 1.1em;
      font-weight: 600;
      margin-bottom: 8px;
      color: #1a1a1a;
    }
    
    .task-description {
      color: #666666;
      font-size: 14px;
      line-height: 1.5;
    }
    
    .task-selection-panel {
      background: #ffffff;
      border: 1px solid #d0d0d0;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    .task-selection-title {
      font-size: 1.1em;
      font-weight: 600;
      margin-bottom: 15px;
      color: #1a1a1a;
    }
    
    .task-options {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 15px;
    }
    
    .task-option {
      background: #ffffff;
      border: 1px solid #d0d0d0;
      border-radius: 8px;
      padding: 20px;
      cursor: pointer;
      transition: all 0.3s ease;
      text-align: center;
      box-shadow: 0 2px 6px rgba(0,0,0,0.08);
    }
    
    .task-option:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 16px rgba(58, 134, 255, 0.15);
      border-color: #3a86ff;
    }
    
    .task-option-icon {
      font-size: 2.5em;
      margin-bottom: 10px;
    }
    
    .task-option-title {
      font-size: 1.35em;
      font-weight: 700;
      margin-bottom: 10px;
      color: #1a1a1a;
    }
    
    .task-option-description {
      font-size: 14px;
      color: #666666;
      line-height: 1.6;
    }
    
    .preview-panel {
      background: #ffffff;
      border: 1px solid #d0d0d0;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    .preview-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
      flex-wrap: wrap;
      gap: 10px;
    }
    
    .preview-title {
      font-size: 1.1em;
      font-weight: 600;
      color: #1a1a1a;
    }
    
    .preview-controls {
      display: flex;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
    }
    
    .preview-select {
      background: #ffffff;
      border: 1px solid #d0d0d0;
      color: #1a1a1a;
      padding: 6px 10px;
      border-radius: 6px;
      font-size: 12px;
    }
    
    .preview-label {
      font-size: 12px;
      color: #666666;
    }
    
    /* ç§»é™¤ç¼©æ”¾æ»‘å—ç›¸å…³æ ·å¼ */
    
    .preview-content { text-align: center; }
    .preview-container { width: 100%; max-height: 60vh; overflow: auto; border: 1px solid #d0d0d0; border-radius: 8px; background:#f8f8f8; position: relative; }
    .preview-image { width: 100%; height: auto; max-height: 60vh; object-fit: contain; display: block; background:#f8f8f8; }
    /* å…¨å±æ ·å¼ï¼Œé¿å…é»‘å±ï¼šå®¹å™¨ä¸å›¾ç‰‡é“ºæ»¡è§†å£å¹¶ä¿æŒç­‰æ¯” */
    .preview-container:fullscreen { width: 100vw; height: 100vh; max-height: none; overflow: hidden; background:#f8f8f8; }
    .preview-image:fullscreen { width: 100vw; height: 100vh; max-height: none; object-fit: contain; background:#f8f8f8; }

    /* è‡ªå®šä¹‰å‚æ•°å¼¹çª— */
    .dialog-backdrop { position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: none; align-items: center; justify-content: center; z-index: 1000; }
    .dialog { background: #ffffff; border: 1px solid #d0d0d0; border-radius: 12px; width: min(560px, 92vw); padding: 18px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
    .dialog-title { font-weight: 700; font-size: 18px; margin-bottom: 12px; color: #1a1a1a; }
    .dialog-row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    .dialog-field { display: flex; flex-direction: column; gap: 6px; margin-bottom: 10px; }
    .dialog-label { font-size: 12px; color: #666666; }
    .dialog-input { padding: 10px 12px; border-radius: 8px; border: 1px solid #d0d0d0; background: #ffffff; color: #1a1a1a; }
    .dialog-actions { display: flex; justify-content: flex-end; gap: 10px; margin-top: 8px; }
    .btn-secondary { background: #e0e0e0; color: #1a1a1a; border: none; padding: 10px 16px; border-radius: 8px; cursor: pointer; }
    .btn-primary { background: #3a86ff; color: #fff; border: none; padding: 10px 16px; border-radius: 8px; cursor: pointer; }
    
    @media (max-width: 768px) {
      .control-panel {
        flex-direction: column;
        align-items: stretch;
      }
      
      .control-btn {
        width: 100%;
      }
      
      .input-container {
        flex-direction: column;
      }
      
      .back-btn {
        position: static;
        margin-bottom: 15px;
      }
    }
  </style>
</head>
<body>
  <button class="back-btn" onclick="goBack()">â† è¿”å›ä¸»ç•Œé¢</button>
  
  <div class="header">
    <h1>AI+ç”µåŠ›ç”µå­</h1>
    <p id="task-title">{% if task == 'ppo' %}å‚æ•°è®¾è®¡{% elif task == 'run_sim' %}ä»¿çœŸéªŒè¯{% elif task == 'run_sim_def' %}è‡ªå®šä¹‰ä»¿çœŸ{% elif task == 'eda' %}åŸç†å›¾/PCBè‡ªåŠ¨è®¾è®¡{% else %}è¿è¡Œä»»åŠ¡{% endif %}</p>
  </div>
  
  <div class="main-content">
    <div class="task-info">
      <div class="task-title">
        {% if task == 'ppo' %}
          å‚æ•°è®¾è®¡ä»»åŠ¡
        {% elif task == 'run_sim' or task == 'run_sim_def' %}
          ä»¿çœŸéªŒè¯ä»»åŠ¡
        {% elif task == 'eda' %}
          åŸç†å›¾/PCBè‡ªåŠ¨è®¾è®¡ä»»åŠ¡
        {% else %}
          è¿è¡Œä»»åŠ¡
        {% endif %}
      </div>
      <div class="task-description">
        {% if task == 'ppo' %}
          ä½¿ç”¨PPOç®—æ³•è‡ªåŠ¨è®¾è®¡Buckå˜æ¢å™¨å…³é”®å‚æ•°ï¼ŒåŒ…æ‹¬ç”µæ„Ÿã€ç”µå®¹ã€å¼€å…³é¢‘ç‡ç­‰ï¼Œç¡®ä¿æœ€ä¼˜æ€§èƒ½ã€‚ï¼ˆåœ¨å®Œæ•´è¿è¡Œåå¯ä»¥è¿›è¡Œå™¨ä»¶é€‰å‹ï¼‰
        {% elif task == 'run_sim' or task == 'run_sim_def' %}
          åœ¨MATLAB/Simulinkç¯å¢ƒä¸­è¿è¡Œä»¿çœŸï¼ŒéªŒè¯è®¾è®¡çš„Buckå˜æ¢å™¨æ€§èƒ½ï¼ŒåŒ…æ‹¬æ•ˆç‡ã€ç¨³å®šæ€§ç­‰æŒ‡æ ‡ã€‚
        {% elif task == 'eda' %}
          è‡ªåŠ¨ç”ŸæˆåŸç†å›¾ä¸PCBåˆç‰ˆæ–‡ä»¶ï¼Œæ”¯æŒå‚æ•°é©±åŠ¨çš„å™¨ä»¶é€‰å‹ä¸åŸºç¡€å¸ƒå±€å¸ƒçº¿å»ºè®®ã€‚
        {% else %}
          æ­£åœ¨è¿è¡ŒæŒ‡å®šçš„ä»»åŠ¡ã€‚
        {% endif %}
      </div>
    </div>
    
    <!-- ä»»åŠ¡é€‰æ‹©é¢æ¿ -->
    <div class="task-selection-panel" id="taskSelectionPanel">
      <div class="task-selection-title">è¯·é€‰æ‹©å…·ä½“ä»»åŠ¡ç±»å‹ï¼š</div>
      <div class="task-options">
        {% if task == 'ppo' %}
          <!-- å‚æ•°è®¾è®¡é€‰é¡¹ï¼ˆppoï¼‰ -->
          <div class="task-option" onclick="selectTaskType('ppo')">
            <div class="task-option-title">åŒçº¿äº¤é”™å¹¶è”Buckæ‹“æ‰‘è‡ªåŠ¨è®¾è®¡</div>
            <div class="task-option-description">ä½¿ç”¨æ ‡å‡†åŒç›¸äº¤é”™å¹¶è”Buckæ‹“æ‰‘è¿›è¡Œè‡ªåŠ¨å‚æ•°è®¾è®¡</div>
          </div>
          <div class="task-option" onclick="selectTaskType('run_sim_def')">
            <div class="task-option-title">è‡ªå®šä¹‰æ‹“æ‰‘å‚æ•°è®¾è®¡</div>
            <div class="task-option-description">ä½¿ç”¨è‡ªå®šä¹‰æ‹“æ‰‘è¿›è¡Œå‚æ•°è®¾è®¡</div>
          </div>
        {% elif task == 'run_sim' or task == 'run_sim_def' %}
          <!-- ä»¿çœŸéªŒè¯é€‰é¡¹ï¼ˆrun_sim / run_sim_defï¼‰ -->
          <div class="task-option" onclick="selectTaskType('run_sim')">
            <div class="task-option-title">åŒç›¸äº¤é”™å¹¶è”Buckæ‹“æ‰‘è‡ªåŠ¨ä»¿çœŸéªŒè¯</div>
            <div class="task-option-description">ä½¿ç”¨æ ‡å‡†åŒç›¸äº¤é”™å¹¶è”Buckæ‹“æ‰‘è¿›è¡Œä»¿çœŸéªŒè¯</div>
          </div>
          <div class="task-option" onclick="selectTaskType('run_sim_def')">
            <div class="task-option-title">è‡ªå®šä¹‰åŒç›¸äº¤é”™å¹¶è”Buckå‚æ•°</div>
            <div class="task-option-description">ä½¿ç”¨è‡ªå®šä¹‰åŒç›¸äº¤é”™å¹¶è”Buckæ‹“æ‰‘å‚æ•°è¿›è¡Œä»¿çœŸéªŒè¯</div>
          </div>
        {% elif task == 'eda' %}
          <!-- åŸç†å›¾/PCBè‡ªåŠ¨è®¾è®¡é€‰é¡¹ï¼ˆedaï¼‰ -->
          <div class="task-option" onclick="selectEdAEntry('eda_buck_dual')">
            <div class="task-option-title">åŒç›¸äº¤é”™å¹¶è”BuckåŸç†å›¾/PCBè‡ªåŠ¨è®¾è®¡</div>
            <div class="task-option-description">è¿›å…¥ååœ¨æœ¬é¡µå±•å¼€åŠŸç‡/æ§åˆ¶/é©±åŠ¨/é‡‡æ ·åŠè‡ªåŠ¨å¸ƒå±€å¸ƒçº¿</div>
          </div>
          <div class="task-option" onclick="selectEdAEntry('eda_custom_topology')">
            <div class="task-option-title">è‡ªå®šä¹‰æ‹“æ‰‘åŸç†å›¾/PCBè‡ªåŠ¨è®¾è®¡</div>
            <div class="task-option-description">ä»¥è‡ªå®šä¹‰æ‹“æ‰‘ä¸ºåŸºç¡€çš„åŸç†å›¾/PCBè®¾è®¡ï¼ˆå ä½ï¼Œåç»­å®ç°ï¼‰</div>
          </div>
        {% endif %}
      </div>
    </div>
    
    <div class="control-panel">
      <button id="start-btn" class="control-btn" onclick="startTask()" disabled>å¼€å§‹è¿è¡Œ</button>
      <button id="stop-btn" class="control-btn danger" onclick="stopTask()" disabled>åœæ­¢è¿è¡Œ</button>
      {% if task == 'ppo' %}
      <button id="device-select-btn" class="control-btn" onclick="openDeviceSelection()" disabled>å™¨ä»¶é€‰å‹</button>
      {% endif %}
      {% if task != 'ppo' %}
      <button id="preview-btn" class="control-btn" onclick="togglePreview()">æ˜¾ç¤ºé¢„è§ˆ</button>
      {% endif %}
      <div class="status-indicator">
        <span class="status-dot" id="status-dot"></span>
        <span id="status-text">è¯·å…ˆé€‰æ‹©ä»»åŠ¡ç±»å‹</span>
      </div>
      <button id="btn-return-selection" class="control-btn" style="margin-left:auto; display:none; background:transparent; color:#1a1a1a; border:1px solid #d0d0d0;" onclick="returnToTaskSelection()">è¿”å›ä»»åŠ¡é€‰æ‹©</button>
    </div>
    
    <!-- é¢„è§ˆé¢æ¿ -->
    <div class="preview-panel" id="previewPanel" style="display: none;">
      <div class="preview-header">
        <div class="preview-title">{% if task == 'eda' %}KiCad å®æ—¶é¢„è§ˆ{% else %}MATLAB/Simulink å®æ—¶é¢„è§ˆ{% endif %}</div>
        <div class="preview-controls">
          <select id="previewFps" class="preview-select">
            <option value="5">5 FPS</option>
            <option value="10">10 FPS</option>
            <option value="15" selected>15 FPS</option>
            <option value="30">30 FPS</option>
          </select>
          <button id="btnPageFullscreen" class="preview-select" style="background:#e0e0e0; color:#1a1a1a;">å…¨å±é¢„è§ˆ</button>
          {% if session.get('role') == 'admin' %}
            <label class="preview-label" style="margin-left:8px;">
              <input id="enableRemoteClick" type="checkbox" /> å¯ç”¨è¿œç¨‹é¼ æ ‡
            </label>
            <label class="preview-label" style="margin-left:8px;">
              <input id="enableRemoteKeyboard" type="checkbox" /> å¯ç”¨è¿œç¨‹é”®ç›˜
            </label>
            <span id="delayHeader" class="preview-label" style="display:none;"> å»¶è¿Ÿï¼š-- ms</span>
          {% else %}
            <input id="userControlPassword" class="preview-select" type="password" placeholder="è¾“å…¥è¿œç¨‹é¼ æ ‡å¯†ç å¹¶å›è½¦" style="background:#ffffff; border:1px solid #d0d0d0; color:#1a1a1a; min-width:260px;" />
            <label class="preview-label" style="margin-left:8px;">
              <input id="enableRemoteClick" type="checkbox" disabled /> å¯ç”¨è¿œç¨‹é¼ æ ‡ï¼ˆæ™®é€šç”¨æˆ·éœ€éªŒè¯ï¼‰
            </label>
            <span id="delayHeader" class="preview-label" style="display:none;"> å»¶è¿Ÿï¼š-- ms</span>
          {% endif %}
        </div>
      </div>
      <div class="preview-content">
        <div class="preview-container">
          <img id="previewImg" alt="é¢„è§ˆ" class="preview-image" />
          <div id="remoteCursor" style="position:absolute;display:none;width:18px;height:18px;border-left:8px solid #ff4444;border-top:4px solid transparent;border-bottom:4px solid transparent;pointer-events:none;"></div>
        </div>
      </div>
    </div>
    
    <div class="output-container">
      <div class="output-header">
        <div class="output-title">è¿è¡Œè¾“å‡º</div>
        <button class="clear-btn" onclick="clearOutput()">æ¸…ç©ºè¾“å‡º</button>
      </div>
      <div class="output-content" id="output-content">ç­‰å¾…å¼€å§‹è¿è¡Œ...</div>
      <div class="input-container">
        <input type="text" class="input-field" id="input-field" placeholder="è¾“å…¥å‘½ä»¤æˆ–å‚æ•°..." disabled>
        <button class="send-btn" id="send-btn" onclick="sendInput()" disabled>å‘é€</button>
      </div>
    </div>
    <!-- è‡ªå®šä¹‰EDAè®¾è®¡è¾“å…¥å¼¹çª—ï¼ˆåŸç†å›¾/PCB-è‡ªå®šä¹‰ï¼‰ -->
    <div id="edaCustomDialog" class="dialog-backdrop">
      <div class="dialog">
        <div class="dialog-title">è‡ªå®šä¹‰åŸç†å›¾/PCBè®¾è®¡å‚æ•°</div>
        <div class="dialog-field">
          <label class="dialog-label" for="eda_topology">æ‹“æ‰‘</label>
          <select id="eda_topology" class="dialog-input">
            <option value="">è¯·é€‰æ‹©</option>
            <option value="Buck">Buck</option>
            <option value="Boost">Boost</option>
            <option value="Buck-Boost">Buck-Boost</option>
            <option value="Flyback">Flyback</option>
            <option value="Forward">Forward</option>
          </select>
        </div>
        <div class="dialog-row">
          <div class="dialog-field">
            <label class="dialog-label" for="eda_Vin">è¾“å…¥ç”µå‹ Vin (V)</label>
            <input id="eda_Vin" class="dialog-input" type="number" step="any" placeholder="å¦‚ 24" />
          </div>
          <div class="dialog-field">
            <label class="dialog-label" for="eda_Vout">è¾“å‡ºç”µå‹ Vout (V)</label>
            <input id="eda_Vout" class="dialog-input" type="number" step="any" placeholder="å¦‚ 12" />
          </div>
        </div>
        <div class="dialog-row">
          <div class="dialog-field">
            <label class="dialog-label" for="eda_Iout">è¾“å‡ºç”µæµ Iout (A)</label>
            <input id="eda_Iout" class="dialog-input" type="number" step="any" placeholder="å¦‚ 10" />
          </div>
          <div class="dialog-field">
            <label class="dialog-label" for="eda_f">å¼€å…³é¢‘ç‡ f (Hz)</label>
            <input id="eda_f" class="dialog-input" type="number" step="any" placeholder="å¦‚ 500000" />
          </div>
        </div>
        <div class="dialog-row">
          <div class="dialog-field">
            <label class="dialog-label" for="eda_ripple_v">è¾“å‡ºçº¹æ³¢ç›®æ ‡ Vripple (%)</label>
            <input id="eda_ripple_v" class="dialog-input" type="number" step="any" placeholder="å¦‚ 1" />
          </div>
          <div class="dialog-field">
            <label class="dialog-label" for="eda_ripple_i">ç”µæ„Ÿç”µæµçº¹æ³¢ç›®æ ‡ Iripple (%)</label>
            <input id="eda_ripple_i" class="dialog-input" type="number" step="any" placeholder="å¦‚ 30" />
          </div>
        </div>
        <div class="dialog-row">
          <div class="dialog-field">
            <label class="dialog-label" for="eda_layers">PCBå±‚æ•°</label>
            <input id="eda_layers" class="dialog-input" type="number" step="1" placeholder="å¦‚ 4" />
          </div>
          <div class="dialog-field">
            <label class="dialog-label" for="eda_copper">é“œåš (oz)</label>
            <input id="eda_copper" class="dialog-input" type="number" step="any" placeholder="å¦‚ 2" />
          </div>
        </div>
        <div class="dialog-row">
          <div class="dialog-field">
            <label class="dialog-label" for="eda_clearance">æœ€å°ç”µæ°”é—´éš™ Clearance (mm)</label>
            <input id="eda_clearance" class="dialog-input" type="number" step="any" placeholder="å¦‚ 1" />
          </div>
          <div class="dialog-field">
            <label class="dialog-label" for="eda_creepage">æœ€å°çˆ¬ç”µè·ç¦» Creepage (mm)</label>
            <input id="eda_creepage" class="dialog-input" type="number" step="any" placeholder="å¦‚ 2.5" />
          </div>
        </div>
        <div class="dialog-row">
          <div class="dialog-field">
            <label class="dialog-label" for="eda_temp">ç¯å¢ƒæ¸©åº¦ (Â°C)</label>
            <input id="eda_temp" class="dialog-input" type="number" step="any" placeholder="å¦‚ 40" />
          </div>
          <div class="dialog-field">
            <label class="dialog-label" for="eda_eff">æ•ˆç‡ç›®æ ‡ (%)</label>
            <input id="eda_eff" class="dialog-input" type="number" step="any" placeholder="å¦‚ 95" />
          </div>
        </div>
        <div class="dialog-field">
          <label class="dialog-label" for="eda_notes">å…¶ä»–æ³¨æ„äº‹é¡¹</label>
          <input id="eda_notes" class="dialog-input" type="text" placeholder="å°è£…åå¥½ã€æ•£çƒ­ã€EMIã€è¿‡æµ/è¿‡å‹ä¿æŠ¤ç­‰" />
        </div>
        <div class="dialog-actions">
          <button type="button" class="btn-secondary" onclick="closeEdaCustomDialog()">å–æ¶ˆ</button>
          <button type="button" class="btn-primary" onclick="submitEdaCustomDesign()">ä¿å­˜</button>
        </div>
      </div>
    </div>
    <!-- è‡ªå®šä¹‰å‚æ•°è¾“å…¥å¼¹çª—ï¼ˆä»¿çœŸéªŒè¯-è‡ªå®šä¹‰ï¼‰ -->
    <div id="customParamDialog" class="dialog-backdrop">
      <div class="dialog">
        <div class="dialog-title">è¾“å…¥è‡ªå®šä¹‰åŒç›¸äº¤é”™å¹¶è”Buckå‚æ•°</div>
        <div class="dialog-row">
          <div class="dialog-field">
            <label class="dialog-label" for="inp_f">å¼€å…³é¢‘ç‡ f (Hz)</label>
            <input id="inp_f" class="dialog-input" type="number" step="any" placeholder="å¦‚ 550000" />
          </div>
          <div class="dialog-field">
            <label class="dialog-label" for="inp_L">ç”µæ„Ÿ L (H)</label>
            <input id="inp_L" class="dialog-input" type="number" step="any" placeholder="å¦‚ 1e-6" />
          </div>
        </div>
        <div class="dialog-row">
          <div class="dialog-field">
            <label class="dialog-label" for="inp_C">ç”µå®¹ C (F)</label>
            <input id="inp_C" class="dialog-input" type="number" step="any" placeholder="å¦‚ 9.6e-6" />
          </div>
          <div class="dialog-field">
            <label class="dialog-label" for="inp_Ron">Ron (Î©)</label>
            <input id="inp_Ron" class="dialog-input" type="number" step="any" placeholder="å¦‚ 0.01" />
          </div>
        </div>
        <div class="dialog-row">
          <div class="dialog-field">
            <label class="dialog-label" for="inp_RL">RL (Î©)</label>
            <input id="inp_RL" class="dialog-input" type="number" step="any" placeholder="å¦‚ 0.01" />
          </div>
          <div class="dialog-field">
            <label class="dialog-label" for="inp_RC">RC (Î©)</label>
            <input id="inp_RC" class="dialog-input" type="number" step="any" placeholder="å¦‚ 0.2" />
          </div>
        </div>
        <div class="dialog-actions">
          <button type="button" class="btn-secondary" onclick="closeCustomDialog()">å–æ¶ˆ</button>
          <button type="button" class="btn-primary" onclick="submitCustomParams()">ä¿å­˜</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    let currentRunId = null;
    let isRunning = false;
    let pollInterval = null;
    let cursor = 0;
    let selectedTaskType = null;
    let previewInterval = null;
    let hasCompletedOneRun = false; // è‡³å°‘å®Œæˆä¸€æ¬¡è¿è¡Œåï¼Œå™¨ä»¶é€‰å‹æ‰å¯ç”¨ï¼ˆä»… ppoï¼‰
    
    const task = '{{ task }}';
    let edaSelectedEntry = null; // ç”¨äº EDA ä¸€çº§å…¥å£é€‰æ‹©ï¼ˆbuck_dual æˆ– custom_topologyï¼‰
    
    // ä»»åŠ¡é€‰æ‹©åŠŸèƒ½
    function selectTaskType(taskType) {
      // å‚æ•°è®¾è®¡ä¸­çš„è‡ªå®šä¹‰æ‹“æ‰‘ï¼šè·³è½¬åˆ°Coze AIåŠ©æ‰‹
      if (task === 'ppo' && taskType === 'run_sim_def') {
        if (confirm('å³å°†è·³è½¬åˆ°AIåŠ©æ‰‹è¿›è¡Œè‡ªå®šä¹‰æ‹“æ‰‘å‚æ•°è®¾è®¡ï¼Œæ˜¯å¦ç»§ç»­ï¼Ÿ')) {
          window.location.href = 'https://www.coze.cn/space/7546496844034162739/ui-builder-preview/7546449200230367284/pc/home';
        }
        return;
      }
      
      // ä»¿çœŸéªŒè¯ä¸­çš„è‡ªå®šä¹‰å‚æ•°ï¼šæ‰“å¼€è¾“å…¥å¼¹çª—
      if ((task === 'run_sim' || task === 'run_sim_def') && taskType === 'run_sim_def') {
        openCustomDialog();
        return;
      }

      selectedTaskType = taskType;
      
      // éšè—ä»»åŠ¡é€‰æ‹©é¢æ¿
      document.getElementById('taskSelectionPanel').style.display = 'none';
      
      // å¯ç”¨å¼€å§‹æŒ‰é’®
      document.getElementById('start-btn').disabled = false;
      
      // æ›´æ–°çŠ¶æ€
      updateStatus('stopped', 'å·²é€‰æ‹©ä»»åŠ¡ç±»å‹ï¼Œå¯ä»¥å¼€å§‹è¿è¡Œ');
      
      // æ˜¾ç¤ºä»»åŠ¡ä¿¡æ¯
      const taskInfo = getTaskInfo(taskType);
      appendOutput(`å·²é€‰æ‹©ä»»åŠ¡: ${taskInfo.title}`);
      appendOutput(`ä»»åŠ¡æè¿°: ${taskInfo.description}`);

      // æ˜¾ç¤ºâ€œè¿”å›ä»»åŠ¡é€‰æ‹©â€æŒ‰é’®
      try { document.getElementById('btn-return-selection').style.display = 'inline-block'; } catch {}
    }

    // EDA ä¸€çº§å…¥å£é€‰æ‹©ï¼šåªå½±å“é¡µé¢å±•ç¤ºï¼Œä¸ç›´æ¥è§¦å‘åç«¯
    function selectEdAEntry(entry) {
      if (task !== 'eda') return;
      edaSelectedEntry = entry;
      // åœ¨è¾“å‡ºä¸­æç¤º
      if (entry === 'eda_buck_dual') {
        // ä»…åŒç›¸äº¤é”™å…¥å£æ—¶ï¼Œç«‹å³è¿›å…¥æœ¬é¡µå­åŠŸèƒ½åŒº
        document.getElementById('taskSelectionPanel').style.display = 'none';
        appendOutput('å·²é€‰æ‹©ï¼šåŒç›¸äº¤é”™BuckåŸç†å›¾/PCBè‡ªåŠ¨è®¾è®¡\n');
        showEdaBuckDualSubButtons();
        document.getElementById('start-btn').disabled = true;
        updateStatus('stopped', 'å·²é€‰æ‹©EDAå…¥å£ï¼Œå¯è¿›è¡Œä¸‹ä¸€æ­¥ç•Œé¢æ“ä½œ');
        try { document.getElementById('btn-return-selection').style.display = 'inline-block'; } catch {}
      } else if (entry === 'eda_custom_topology') {
        // è‡ªå®šä¹‰æ‹“æ‰‘ï¼šå…ˆå¼¹çª—é‡‡é›†å‚æ•°ï¼›æœªä¿å­˜å‰ç¦æ­¢é¡µé¢è·³è½¬
        appendOutput('å·²é€‰æ‹©ï¼šè‡ªå®šä¹‰æ‹“æ‰‘åŸç†å›¾/PCBè‡ªåŠ¨è®¾è®¡\n');
        openEdaCustomDialog();
        // ä¿æŒä»»åŠ¡é€‰æ‹©é¢æ¿å¯è§ï¼Œä¸æ”¹å˜æŒ‰é’®ä¸è¿”å›é”®çŠ¶æ€
        try { document.getElementById('btn-return-selection').style.display = 'none'; } catch {}
        document.getElementById('start-btn').disabled = true;
        updateStatus('stopped', 'è¯·å…ˆå®Œæˆè‡ªå®šä¹‰å‚æ•°å¡«å†™å¹¶ä¿å­˜');
      }
    }

    function showEdaBuckDualSubButtons() {
      // åœ¨æ§åˆ¶é¢æ¿ä¸‹æ–¹åŠ¨æ€æ’å…¥ä¸€ä¸ªEDAå­åŠŸèƒ½åŒºåŸŸ
      const containerId = 'edaBuckDualPanel';
      if (document.getElementById(containerId)) return;
      const panel = document.createElement('div');
      panel.id = containerId;
      panel.className = 'task-selection-panel';
      panel.innerHTML = `
        <div class="task-selection-title">è¯·é€‰æ‹©å­åŠŸèƒ½ï¼š</div>
        <div class="task-options">
          <div class="task-option" onclick="edaSubAction('power')">
            <div class="task-option-title">æ•´ä½“ç”µè·¯è®¾è®¡</div>
            <div class="task-option-description">ç»™å‡ºåŒç›¸äº¤é”™å¹¶è”Buckçš„æ•´ä½“åŸç†å›¾/PCBè®¾è®¡</div>
          </div>
          <div class="task-option" onclick="edaSubAction('auto_route')">
            <div class="task-option-title">è‡ªåŠ¨å¸ƒçº¿</div>
            <div class="task-option-description">è‡ªåŠ¨å¸ƒçº¿å·¥å…·ï¼Œè¾…åŠ©æ‰“å¼€PCBå¹¶å¼€å§‹è‡ªåŠ¨å¸ƒçº¿</div>
          </div>
          <div class="task-option" onclick="edaSubAction('design_demo')">
            <div class="task-option-title">è‡ªåŠ¨è®¾è®¡æ¼”ç¤º</div>
            <div class="task-option-description">æ¼”ç¤ºåŒç›¸äº¤é”™å¹¶è”Buckçš„è‡ªåŠ¨è®¾è®¡è¿‡ç¨‹</div>
          </div>
        </div>
      `;
      // æ’å…¥åˆ°è¾“å‡ºé¢æ¿ä¹‹å‰
      const mainContent = document.querySelector('.main-content');
      const outputContainer = document.querySelector('.output-container');
      mainContent.insertBefore(panel, outputContainer);
    }

    async function edaSubAction(action) {
      const labels = {
        power: 'æ•´ä½“ç”µè·¯è®¾è®¡',
        auto_route: 'è‡ªåŠ¨å¸ƒçº¿',
        design_demo: 'è‡ªåŠ¨è®¾è®¡æ¼”ç¤º'
      };
      
      // æ•´ä½“ç”µè·¯è®¾è®¡åŠŸèƒ½
      if (action === 'power') {
        appendOutput(`\n${'='.repeat(60)}\n`);
        appendOutput(`ğŸš€ å¼€å§‹æ‰§è¡ŒåŒç›¸äº¤é”™å¹¶è”Buckæ•´ä½“ç”µè·¯è®¾è®¡\n`);
        appendOutput(`${'='.repeat(60)}\n\n`);
        
        // æ¨¡æ‹Ÿè‡ªåŠ¨è®¾è®¡çš„é€æ­¥è¿‡ç¨‹
        appendOutput(`ğŸ“Š æ­£åœ¨åˆ†æè®¾è®¡éœ€æ±‚...\n`);
        await sleep(800);
        appendOutput(`  âœ“ æ‹“æ‰‘ç»“æ„ï¼šåŒç›¸äº¤é”™å¹¶è”Buck\n`);
        appendOutput(`  âœ“ è¾“å…¥ç”µå‹ï¼š48V\n`);
        appendOutput(`  âœ“ è¾“å‡ºç”µå‹ï¼š12V\n`);
        await sleep(600);
        
        appendOutput(`\nğŸ”§ æ­£åœ¨ç”ŸæˆåŠŸç‡ç”µè·¯...\n`);
        await sleep(700);
        appendOutput(`  âœ“ é€‰æ‹©å¼€å…³å™¨ä»¶ï¼šMOSFET (2ä¸ª)\n`);
        await sleep(500);
        appendOutput(`  âœ“ è®¾è®¡ç”µæ„Ÿå‚æ•°ï¼šL1=1uH, L2=1uH\n`);
        await sleep(500);
        appendOutput(`  âœ“ è®¾è®¡è¾“å‡ºç”µå®¹ï¼šC_out=10uF\n`);
        await sleep(600);
        
        appendOutput(`\nâš¡ æ­£åœ¨ç”Ÿæˆæ§åˆ¶ç”µè·¯...\n`);
        await sleep(700);
        appendOutput(`  âœ“ æ§åˆ¶èŠ¯ç‰‡ï¼šTMS320F28335\n`);
        await sleep(500);
        
        appendOutput(`\nğŸ”Œ æ­£åœ¨ç”Ÿæˆé©±åŠ¨ç”µè·¯...\n`);
        await sleep(650);
        appendOutput(`  âœ“ æ …æé©±åŠ¨ï¼šé©±åŠ¨ç”µè·¯\n`);
        await sleep(500);
        appendOutput(`  âœ“ è‡ªä¸¾ç”µè·¯ï¼šè‡ªä¸¾ç”µå®¹ + äºŒæç®¡\n`);
        await sleep(600);
        
        appendOutput(`\nğŸ“¡ æ­£åœ¨ç”Ÿæˆé‡‡æ ·ç”µè·¯...\n`);
        await sleep(700);
        appendOutput(`  âœ“ ç”µå‹é‡‡æ ·\n`);
        await sleep(600);
        
        appendOutput(`\nâœ¨ è®¾è®¡ç”Ÿæˆå®Œæˆï¼æ­£åœ¨æ‰“å¼€KiCad...\n\n`);
        await sleep(500);
        
        try {
          const response = await fetch('/api/eda/open_design', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({})
          });
          
          const result = await response.json();
          
          if (result.status === 'success') {
            appendOutput(`${'='.repeat(60)}\n`);
            appendOutput(`âœ… KiCadè®¾è®¡æ–‡ä»¶å·²æ‰“å¼€\n`);
            appendOutput(`${'='.repeat(60)}\n\n`);
            
            if (result.schematic_opened) {
              appendOutput(`ğŸ“ åŸç†å›¾ç¼–è¾‘å™¨: å·²æ‰“å¼€`);
              if (result.schematic_maximized) {
                appendOutput();
              }
              appendOutput(`\n   æ–‡ä»¶: ${result.schematic_path}\n\n`);
            }
            
            if (result.pcb_opened) {
              appendOutput(`ğŸ–¼ï¸  PCBç¼–è¾‘å™¨: å·²æ‰“å¼€`);
              if (result.pcb_maximized) {
                appendOutput();
              }
              appendOutput(`\n   æ–‡ä»¶: ${result.pcb_path}\n\n`);
            }
            
            appendOutput(`${'='.repeat(60)}\n`);
            appendOutput(`ğŸ’¡ æç¤ºï¼šçª—å£å·²å…¨å±æ˜¾ç¤ºï¼Œå¯ç›´æ¥æŸ¥çœ‹å’Œç¼–è¾‘è®¾è®¡\n`);
            if (result.schematic_opened && result.pcb_opened) {
              appendOutput(`ğŸ’¡ æç¤ºï¼šä½¿ç”¨Alt+Tabå¯åœ¨åŸç†å›¾å’ŒPCBä¹‹é—´åˆ‡æ¢\n`);
            }
            appendOutput(`${'='.repeat(60)}\n\n`);
          } else {
            appendOutput(`âŒ æ‰“å¼€å¤±è´¥: ${result.error}\n`);
            if (result.traceback) {
              appendOutput(`\né”™è¯¯è¯¦æƒ…:\n${result.traceback}\n`);
            }
          }
        } catch (err) {
          appendOutput(`âŒ è¯·æ±‚å¤±è´¥: ${err.message}\n`);
        }
        
        return;
      }
      
      // è‡ªåŠ¨å¸ƒçº¿åŠŸèƒ½å·²å®ç°
      if (action === 'auto_route') {
        appendOutput(`æ­£åœ¨å¯åŠ¨å¸ƒçº¿åŠŸèƒ½...\n`);
        appendOutput(`æ­£åœ¨æ‰“å¼€KiCad PCBç¼–è¾‘å™¨...\n`);
        
        try {
          const response = await fetch('/api/eda/auto_route', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({})
          });
          
          const result = await response.json();
          
          if (result.status === 'success') {
            appendOutput(`âœ“ ${result.message}\n`);
            appendOutput(`PCBæ–‡ä»¶: ${result.pcb_path}\n`);
            appendOutput(`KiCadè·¯å¾„: ${result.kicad_path}\n`);
            appendOutput(`è¿›ç¨‹ID: ${result.pid}\n\n`);
            
            // æ˜¾ç¤ºæ“ä½œæ­¥éª¤
            if (result.manual_steps && result.manual_steps.length > 0) {
              appendOutput(`============================================\n`);
              appendOutput(`ğŸ“‹ è¯·æŒ‰ç…§ä»¥ä¸‹æ­¥éª¤è¿›è¡ŒFreeRoutingè‡ªåŠ¨å¸ƒçº¿ï¼š\n`);
              appendOutput(`============================================\n\n`);
              
              result.manual_steps.forEach(step => {
                appendOutput(`${step}\n`);
              });
              
              if (result.quick_tip) {
                appendOutput(`\nğŸ’¡ ${result.quick_tip}\n`);
              }
              
              appendOutput(`\n============================================\n`);
              appendOutput(`æç¤ºï¼šKiCad PCBç¼–è¾‘å™¨å·²æ‰“å¼€ï¼Œè¯·åœ¨çª—å£ä¸­è¿›è¡Œä¸Šè¿°æ“ä½œ\n`);
              appendOutput(`============================================\n\n`);
            }
          } else {
            appendOutput(`âœ— å¯åŠ¨å¤±è´¥: ${result.error}\n`);
            if (result.traceback) {
              appendOutput(`\né”™è¯¯è¯¦æƒ…:\n${result.traceback}\n`);
            }
            alert(`å¸ƒçº¿åŠŸèƒ½å¯åŠ¨å¤±è´¥: ${result.error}`);
          }
        } catch (err) {
          appendOutput(`âœ— è¯·æ±‚å¤±è´¥: ${err.message}\n`);
          alert(`è¯·æ±‚å¤±è´¥: ${err.message}`);
        }
        return;
      }
      
      // è®¾è®¡æ¼”ç¤ºåŠŸèƒ½ - è·³è½¬åˆ°ä¸“ç”¨ç¼–è¾‘å™¨é¡µé¢
      if (action === 'design_demo') {
        appendOutput(`\n${'='.repeat(60)}\n`);
        appendOutput(`ğŸ¬ å¼€å§‹è‡ªåŠ¨è®¾è®¡æ¼”ç¤º\n`);
        appendOutput(`${'='.repeat(60)}\n\n`);
        
        appendOutput(`ğŸ“‹ æ­£åœ¨åŠ è½½è®¾è®¡æ–‡ä»¶...\n`);
        await sleep(500);
        appendOutput(`âœ“ è®¾è®¡æ–‡ä»¶å‡†å¤‡å°±ç»ª\n\n`);
        await sleep(300);
        
        appendOutput(`ğŸ”§ æ­£åœ¨æ‰“å¼€åŸç†å›¾ç¼–è¾‘å™¨é¡µé¢...\n`);
        await sleep(500);
        
        // è·³è½¬åˆ°åŸç†å›¾ç¼–è¾‘å™¨é¡µé¢
        window.location.href = '/schematic_editor';
        
        return;
      }
      
      // å…¶ä»–åŠŸèƒ½æš‚æœªå®ç°
      appendOutput(`[å ä½] è§¦å‘ï¼š${labels[action] || action}\n`);
      alert(labels[action] + ' åŠŸèƒ½å°šæœªå®ç°ï¼Œæœ¬æ¬¡ä¸ºé¡µé¢å ä½ã€‚');
    }

    function openCustomDialog() {
      try { document.getElementById('customParamDialog').style.display = 'flex'; } catch {}
    }
    function closeCustomDialog() {
      try { document.getElementById('customParamDialog').style.display = 'none'; } catch {}
    }
    function openEdaCustomDialog() {
      try { document.getElementById('edaCustomDialog').style.display = 'flex'; } catch {}
    }
    function closeEdaCustomDialog() {
      try { document.getElementById('edaCustomDialog').style.display = 'none'; } catch {}
    }
    async function submitEdaCustomDesign() {
      const topology = (document.getElementById('eda_topology').value || '').trim();
      const Vin = parseFloat(document.getElementById('eda_Vin').value || '');
      const Vout = parseFloat(document.getElementById('eda_Vout').value || '');
      const Iout = parseFloat(document.getElementById('eda_Iout').value || '');
      const f = parseFloat(document.getElementById('eda_f').value || '');
      const ripple_v = parseFloat(document.getElementById('eda_ripple_v').value || '');
      const ripple_i = parseFloat(document.getElementById('eda_ripple_i').value || '');
      const layers = parseInt(document.getElementById('eda_layers').value || '');
      const copper_oz = parseFloat(document.getElementById('eda_copper').value || '');
      const clearance = parseFloat(document.getElementById('eda_clearance').value || '');
      const creepage = parseFloat(document.getElementById('eda_creepage').value || '');
      const temp_ambient = parseFloat(document.getElementById('eda_temp').value || '');
      const efficiency = parseFloat(document.getElementById('eda_eff').value || '');
      const notes = (document.getElementById('eda_notes').value || '').trim();
      if (!topology || Number.isNaN(Vin) || Number.isNaN(Vout)) { alert('è¯·è‡³å°‘é€‰æ‹©æ‹“æ‰‘å¹¶å¡«å†™Vin/Vout'); return; }
      try {
        const res = await fetch('/api/eda/custom_design', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ topology, Vin, Vout, Iout, f, ripple_v, ripple_i, layers, copper_oz, clearance, creepage, temp_ambient, efficiency, notes }) });
        const data = await res.json();
        if (!res.ok || !data || data.status !== 'success') throw new Error(data && data.error ? data.error : 'ä¿å­˜å¤±è´¥');
        closeEdaCustomDialog();
        
        // ä¿å­˜æˆåŠŸï¼šéšè—ä»»åŠ¡é€‰æ‹©é¢æ¿ï¼Œæ˜¾ç¤º"è¿”å›ä»»åŠ¡é€‰æ‹©"æŒ‰é’®
        try { document.getElementById('taskSelectionPanel').style.display = 'none'; } catch {}
        try { document.getElementById('btn-return-selection').style.display = 'inline-block'; } catch {}
        // è‡ªå®šä¹‰æ‹“æ‰‘æœªå¯åŠ¨åç«¯ä»»åŠ¡ï¼Œä¿æŒå¼€å§‹æŒ‰é’®ç¦ç”¨
        try { document.getElementById('start-btn').disabled = true; } catch {}
        updateStatus('stopped', 'EDAè‡ªå®šä¹‰å‚æ•°å·²ä¿å­˜');
        appendOutput('EDAè‡ªå®šä¹‰å‚æ•°å·²ä¿å­˜åˆ°: ' + (data.path || 'Visualization/eda_custom_design.csv') + '\n');
        
        // å¤åˆ¶è®¾è®¡éœ€æ±‚æ–‡å­—åˆ°å‰ªè´´æ¿
        if (data.requirement_text) {
          try {
            await navigator.clipboard.writeText(data.requirement_text);
            appendOutput('âœ“ è®¾è®¡éœ€æ±‚å·²å¤åˆ¶åˆ°å‰ªè´´æ¿\n');
            appendOutput('âœ“ è®¾è®¡éœ€æ±‚å·²ä¿å­˜åˆ°: ' + data.txt_path + '\n\n');
            
            // å¼¹çª—æç¤ºç”¨æˆ·ï¼Œå¹¶è¯¢é—®æ˜¯å¦è·³è½¬
            const shouldJump = confirm('âœ… ä¿å­˜æˆåŠŸï¼\n\n' + 
                  'ğŸ“‹ è®¾è®¡éœ€æ±‚æ–‡å­—å·²å¤åˆ¶åˆ°å‰ªè´´æ¿\n' +
                  'ğŸ“„ æ–‡ä»¶å·²ä¿å­˜åˆ°: ' + data.txt_path + '\n\n' +
                  'æ˜¯å¦è·³è½¬åˆ°è‡ªå®šä¹‰åŸç†å›¾ç¼–è¾‘å™¨ï¼Ÿ\n\n' +
                  'ç‚¹å‡»"ç¡®å®š"è·³è½¬ï¼Œç‚¹å‡»"å–æ¶ˆ"ç•™åœ¨å½“å‰é¡µé¢');
            
            if (shouldJump) {
              // è·³è½¬åˆ°è‡ªå®šä¹‰åŸç†å›¾ç¼–è¾‘å™¨é¡µé¢
              window.location.href = '/custom_schematic_editor';
            } else {
              appendOutput('â„¹ ç”¨æˆ·é€‰æ‹©ç•™åœ¨å½“å‰é¡µé¢\n');
            }
            
          } catch (clipboardErr) {
            // å¦‚æœå‰ªè´´æ¿APIå¤±è´¥ï¼Œä½¿ç”¨å¤‡ç”¨æ–¹æ³•
            const textArea = document.createElement('textarea');
            textArea.value = data.requirement_text;
            textArea.style.position = 'fixed';
            textArea.style.left = '-999999px';
            document.body.appendChild(textArea);
            textArea.select();
            try {
              document.execCommand('copy');
              appendOutput('âœ“ è®¾è®¡éœ€æ±‚å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼ˆå¤‡ç”¨æ–¹æ³•ï¼‰\n');
              appendOutput('âœ“ è®¾è®¡éœ€æ±‚å·²ä¿å­˜åˆ°: ' + data.txt_path + '\n\n');
              
              // å¼¹çª—æç¤ºç”¨æˆ·ï¼Œå¹¶è¯¢é—®æ˜¯å¦è·³è½¬
              const shouldJump = confirm('âœ… ä¿å­˜æˆåŠŸï¼\n\n' + 
                    'ğŸ“‹ è®¾è®¡éœ€æ±‚æ–‡å­—å·²å¤åˆ¶åˆ°å‰ªè´´æ¿\n' +
                    'ğŸ“„ æ–‡ä»¶å·²ä¿å­˜åˆ°: ' + data.txt_path + '\n\n' +
                    'æ˜¯å¦è·³è½¬åˆ°è‡ªå®šä¹‰åŸç†å›¾ç¼–è¾‘å™¨ï¼Ÿ\n\n' +
                    'ç‚¹å‡»"ç¡®å®š"è·³è½¬ï¼Œç‚¹å‡»"å–æ¶ˆ"ç•™åœ¨å½“å‰é¡µé¢');
              
              if (shouldJump) {
                // è·³è½¬åˆ°è‡ªå®šä¹‰åŸç†å›¾ç¼–è¾‘å™¨é¡µé¢
                window.location.href = '/custom_schematic_editor';
              } else {
                appendOutput('â„¹ ç”¨æˆ·é€‰æ‹©ç•™åœ¨å½“å‰é¡µé¢\n');
              }
              
            } catch (err) {
              appendOutput('âš  æ— æ³•å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼Œä½†æ–‡ä»¶å·²ä¿å­˜\n');
              
              // å¼¹çª—æç¤ºç”¨æˆ·ï¼Œå¹¶è¯¢é—®æ˜¯å¦è·³è½¬
              const shouldJump = confirm('âœ… ä¿å­˜æˆåŠŸï¼\n\n' + 
                    'ğŸ“„ æ–‡ä»¶å·²ä¿å­˜åˆ°: ' + data.txt_path + '\n\n' +
                    'âš  è‡ªåŠ¨å¤åˆ¶åˆ°å‰ªè´´æ¿å¤±è´¥\n\n' +
                    'æ˜¯å¦è·³è½¬åˆ°è‡ªå®šä¹‰åŸç†å›¾ç¼–è¾‘å™¨ï¼Ÿ\n\n' +
                    'ç‚¹å‡»"ç¡®å®š"è·³è½¬ï¼Œç‚¹å‡»"å–æ¶ˆ"ç•™åœ¨å½“å‰é¡µé¢');
              
              if (shouldJump) {
                // è·³è½¬åˆ°è‡ªå®šä¹‰åŸç†å›¾ç¼–è¾‘å™¨é¡µé¢
                window.location.href = '/custom_schematic_editor';
              } else {
                appendOutput('â„¹ ç”¨æˆ·é€‰æ‹©ç•™åœ¨å½“å‰é¡µé¢\n');
              }
              
            } finally {
              document.body.removeChild(textArea);
            }
          }
        }
      } catch (e) {
        alert('ä¿å­˜å¤±è´¥ï¼š' + (e && e.message ? e.message : e));
      }
    }
    async function submitCustomParams() {
      const f = parseFloat(document.getElementById('inp_f').value || '');
      const L = parseFloat(document.getElementById('inp_L').value || '');
      const C = parseFloat(document.getElementById('inp_C').value || '');
      const Ron = parseFloat(document.getElementById('inp_Ron').value || '');
      const RL = parseFloat(document.getElementById('inp_RL').value || '');
      const RC = parseFloat(document.getElementById('inp_RC').value || '');
      if ([f,L,C,Ron,RL,RC].some(v => Number.isNaN(v))) { alert('è¯·å®Œæ•´å¡«å†™æ•°å€¼å‚æ•°'); return; }
      try {
        const res = await fetch('/api/custom_params', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ f, L, C, Ron, RL, RC }) });
        const data = await res.json();
        if (!res.ok || !data || data.status !== 'success') throw new Error(data && data.error ? data.error : 'ä¿å­˜å¤±è´¥');
        closeCustomDialog();
        selectedTaskType = 'run_sim_def';
        document.getElementById('taskSelectionPanel').style.display = 'none';
        document.getElementById('start-btn').disabled = false;
        updateStatus('stopped', 'å‚æ•°å·²ä¿å­˜ï¼Œå¯å¼€å§‹è¿è¡Œ');
        appendOutput('å‚æ•°å·²ä¿å­˜åˆ°: ' + (data.path || 'Visualization/self_defined_para.csv'));
        
        // æ˜¾ç¤º"è¿”å›ä»»åŠ¡é€‰æ‹©"æŒ‰é’®
        try { document.getElementById('btn-return-selection').style.display = 'inline-block'; } catch {}
      } catch (e) {
        alert('ä¿å­˜å¤±è´¥ï¼š' + (e && e.message ? e.message : e));
      }
    }
    
    function getTaskInfo(taskType) {
      const taskInfos = {
        'ppo': {
          title: 'åŒç›¸äº¤é”™å¹¶è”Buckæ‹“æ‰‘è‡ªåŠ¨è®¾è®¡',
          description: 'ä½¿ç”¨æ ‡å‡†åŒç›¸äº¤é”™å¹¶è”Buckæ‹“æ‰‘è¿›è¡Œè‡ªåŠ¨å‚æ•°è®¾è®¡'
        },
        'run_sim': {
          title: 'åŒç›¸äº¤é”™å¹¶è”Buckæ‹“æ‰‘è‡ªåŠ¨ä»¿çœŸéªŒè¯',
          description: 'ä½¿ç”¨æ ‡å‡†åŒç›¸äº¤é”™å¹¶è”Buckæ‹“æ‰‘è¿›è¡Œä»¿çœŸéªŒè¯'
        },
        'run_sim_def': {
          title: task === 'ppo' ? 'è‡ªå®šä¹‰æ‹“æ‰‘å‚æ•°è®¾è®¡' : 'è‡ªå®šä¹‰åŒç›¸äº¤é”™å¹¶è”Buckå‚æ•°',
          description: task === 'ppo' ? 'ä½¿ç”¨è‡ªå®šä¹‰æ‹“æ‰‘è¿›è¡Œå‚æ•°è®¾è®¡' : 'ä½¿ç”¨è‡ªå®šä¹‰åŒç›¸äº¤é”™å¹¶è”Buckæ‹“æ‰‘å‚æ•°è¿›è¡Œä»¿çœŸéªŒè¯'
        },
        'eda_auto': {
          title: 'è‡ªåŠ¨ç”ŸæˆåŸç†å›¾/PCB',
          description: 'åŸºäºè®¾è®¡å‚æ•°è‡ªåŠ¨ç”ŸæˆåŸç†å›¾ä¸PCBåˆç‰ˆ'
        },
        'eda_custom': {
          title: 'è‡ªå®šä¹‰EDAå‚æ•°ç”Ÿæˆ',
          description: 'è®¾ç½®å°è£…ã€èµ°çº¿ã€å±‚å ç­‰åå¥½åç”ŸæˆåŸç†å›¾ä¸PCB'
        }
      };
      return taskInfos[taskType] || { title: 'æœªçŸ¥ä»»åŠ¡', description: '' };
    }
    
    function updateStatus(status, text) {
      const dot = document.getElementById('status-dot');
      const textEl = document.getElementById('status-text');
      const startBtn = document.getElementById('start-btn');
      const stopBtn = document.getElementById('stop-btn');
      const inputField = document.getElementById('input-field');
      const sendBtn = document.getElementById('send-btn');
      
      dot.className = 'status-dot ' + status;
      textEl.textContent = text;
      
      if (status === 'running') {
        isRunning = true;
        startBtn.disabled = true;
        stopBtn.disabled = false;
        inputField.disabled = false;
        sendBtn.disabled = false;
        try { if (task === 'ppo') document.getElementById('device-select-btn').disabled = true; } catch {}
      } else {
        isRunning = false;
        startBtn.disabled = false;
        stopBtn.disabled = true;
        inputField.disabled = true;
        sendBtn.disabled = true;
        // éè¿è¡ŒçŠ¶æ€ä¸è‡ªåŠ¨å¯ç”¨å™¨ä»¶é€‰å‹ï¼Œéœ€åœ¨é¦–æ¬¡å®Œæˆæ—¶æ‰‹åŠ¨å¯ç”¨
      }
    }

    // è¿”å›ä»»åŠ¡é€‰æ‹©ï¼šæ¢å¤åˆå§‹çŠ¶æ€ä¸ç•Œé¢
    function returnToTaskSelection() {
      // åœæ­¢è¿è¡Œä¸é¢„è§ˆ
      try { if (isRunning) stopTask(); } catch {}
      try { stopPreview(); } catch {}

      // æ¸…ç†å·²é€‰æ‹©çŠ¶æ€
      selectedTaskType = null;
      edaSelectedEntry = null;
      hasCompletedOneRun = false;
      updateStatus('stopped', 'è¯·å…ˆé€‰æ‹©ä»»åŠ¡ç±»å‹');

      // æ¸…ç©ºè¾“å‡ºå¹¶æç¤º
      clearOutput();
      appendOutput('å·²è¿”å›ä»»åŠ¡é€‰æ‹©ï¼Œè¯·å…ˆé€‰æ‹©ä»»åŠ¡ç±»å‹\n');

      // æ˜¾ç¤ºä»»åŠ¡é€‰æ‹©é¢æ¿
      try { document.getElementById('taskSelectionPanel').style.display = 'block'; } catch {}

      // éšè—â€œè¿”å›ä»»åŠ¡é€‰æ‹©â€æŒ‰é’®
      try { document.getElementById('btn-return-selection').style.display = 'none'; } catch {}

      // å…³é—­å¹¶ç§»é™¤ EDA å­é¢æ¿
      const edaPanel = document.getElementById('edaBuckDualPanel');
      if (edaPanel && edaPanel.parentNode) {
        edaPanel.parentNode.removeChild(edaPanel);
      }

      // éšè—ä¸ç¦ç”¨å™¨ä»¶é€‰å‹æŒ‰é’®
      try { if (task === 'ppo') document.getElementById('device-select-btn').disabled = true; } catch {}
    }
    // å™¨ä»¶é€‰å‹ï¼šéœ€å·²å®Œæˆä¸€æ¬¡è¿è¡Œ
    function openDeviceSelection() {
      if (task !== 'ppo') return;
      if (!hasCompletedOneRun) {
        alert('è¯·å…ˆå®Œæ•´æ‰§è¡Œä¸€æ¬¡å¼€å§‹è¿è¡Œï¼Œå†è¿›è¡Œå™¨ä»¶é€‰å‹ã€‚');
        return;
      }
      const ok = confirm('è¯·ç¡®è®¤å·²ç»å¤åˆ¶PPOè®­ç»ƒæ‘˜è¦æŠ¥å‘Šï¼Œå³å°†è·³è½¬åˆ°å™¨ä»¶é€‰å‹é¡µé¢ã€‚');
      if (!ok) return;
      window.location.href = 'https://www.coze.cn/space/7546496844034162739/ui-builder-preview/7546449200230367284/pc/iIJztG9qCF';
    }
    
    function sleep(ms) {
      return new Promise(resolve => setTimeout(resolve, ms));
    }
    
    function appendOutput(text) {
      const output = document.getElementById('output-content');
      output.textContent += text;
      output.scrollTop = output.scrollHeight;
    }
    
    function clearOutput() {
      document.getElementById('output-content').textContent = '';
    }
    
    function startTask() {
      if (isRunning) return;
      
      if (!selectedTaskType) {
        alert('è¯·å…ˆé€‰æ‹©ä»»åŠ¡ç±»å‹');
        return;
      }
      
      // ä»…å½“å‚æ•°è®¾è®¡ä»»åŠ¡å®Œæˆè¿‡ä¸€æ¬¡åï¼Œå…è®¸å™¨ä»¶é€‰å‹
      try { if (task === 'ppo') document.getElementById('device-select-btn').disabled = true; } catch {}

      updateStatus('running', 'å¯åŠ¨ä¸­...');
      clearOutput();
      
      fetch('/api/run/start', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ task: selectedTaskType })
      })
      .then(response => response.json())
      .then(data => {
        if (data.error) {
          updateStatus('stopped', 'å¯åŠ¨å¤±è´¥');
          appendOutput('å¯åŠ¨å¤±è´¥: ' + data.error + '\n');
        } else {
          currentRunId = data.run_id;
          cursor = data.next || 0;
          updateStatus('running', 'è¿è¡Œä¸­');
          startPolling();
        }
      })
      .catch(error => {
        console.error('Error:', error);
        updateStatus('stopped', 'å¯åŠ¨å¤±è´¥');
        appendOutput('å¯åŠ¨æ—¶å‘ç”Ÿé”™è¯¯: ' + error.message + '\n');
      });
    }
    
    function stopTask() {
      if (!isRunning || !currentRunId) return;
      
      fetch('/api/run/stop', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ run_id: currentRunId })
      })
      .then(response => response.json())
      .then(data => {
        if (data.error) {
          appendOutput('åœæ­¢å¤±è´¥: ' + data.error + '\n');
        } else {
          updateStatus('stopped', 'å·²åœæ­¢');
          appendOutput('\n[ä»»åŠ¡å·²åœæ­¢]\n');
          // æœªå®Œæˆåˆ™ä¸è§£é”å™¨ä»¶é€‰å‹
        }
      })
      .catch(error => {
        console.error('Error:', error);
        appendOutput('åœæ­¢æ—¶å‘ç”Ÿé”™è¯¯: ' + error.message + '\n');
      });
      
      if (pollInterval) {
        clearInterval(pollInterval);
        pollInterval = null;
      }
      currentRunId = null;
    }
    
    function startPolling() {
      if (pollInterval) {
        clearInterval(pollInterval);
      }
      
      pollInterval = setInterval(() => {
        if (!currentRunId) return;
        
        fetch(`/api/run/poll?run_id=${currentRunId}&cursor=${cursor}`)
        .then(response => response.json())
        .then(data => {
          if (data.error) {
            console.error('Poll error:', data.error);
            return;
          }
          
          if (data.lines && data.lines.length > 0) {
            const newText = data.lines.join('\n') + '\n';
            appendOutput(newText);
            cursor = data.next;
          }
          
          if (data.done) {
            updateStatus('stopped', 'è¿è¡Œå®Œæˆ');
            // æ ‡è®°å®Œæˆä¸€æ¬¡è¿è¡Œ
            hasCompletedOneRun = true;
            // å¯ç”¨å™¨ä»¶é€‰å‹ï¼ˆä»… ppoï¼‰
            try { if (task === 'ppo') document.getElementById('device-select-btn').disabled = false; } catch {}
            if (pollInterval) {
              clearInterval(pollInterval);
              pollInterval = null;
            }
            currentRunId = null;
          }
        })
        .catch(error => {
          console.error('Poll error:', error);
        });
      }, 1000);
    }
    
    function sendInput() {
      const inputField = document.getElementById('input-field');
      const text = inputField.value.trim();
      
      if (!text || !currentRunId) return;
      
      fetch('/api/run/input', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ 
          run_id: currentRunId,
          text: text
        })
      })
      .then(response => response.json())
      .then(data => {
        if (data.error) {
          appendOutput('è¾“å…¥å¤±è´¥: ' + data.error + '\n');
        } else {
          appendOutput('> ' + text + '\n');
          inputField.value = '';
        }
      })
      .catch(error => {
        console.error('Error:', error);
        appendOutput('è¾“å…¥æ—¶å‘ç”Ÿé”™è¯¯: ' + error.message + '\n');
      });
    }
    
    // é¢„è§ˆåŠŸèƒ½
    function togglePreview() {
      const previewPanel = document.getElementById('previewPanel');
      const previewBtn = document.getElementById('preview-btn');
      
      if (previewPanel.style.display === 'none') {
        previewPanel.style.display = 'block';
        previewBtn.textContent = 'éšè—é¢„è§ˆ';
        startPreview();
      } else {
        previewPanel.style.display = 'none';
        previewBtn.textContent = 'æ˜¾ç¤ºé¢„è§ˆ';
        stopPreview();
      }
    }
    
    function startPreview() {
      if (previewInterval) {
        clearInterval(previewInterval);
      }
      
      const previewImg = document.getElementById('previewImg');
      const fps = parseInt(document.getElementById('previewFps').value) || 15;
      const interval = 1000 / fps;
      
      function updatePreview() {
        const timestamp = Date.now();
        previewImg.src = `/api/stream/matlab?target=screen&fps=${fps}&_=${timestamp}`;
      }
      
      // ç«‹å³æ›´æ–°ä¸€æ¬¡
      updatePreview();
      
      // è®¾ç½®å®šæ—¶æ›´æ–°
      previewInterval = setInterval(updatePreview, interval);
    }
    
    function stopPreview() {
      if (previewInterval) {
        clearInterval(previewInterval);
        previewInterval = null;
      }
    }
    
    function goBack() {
      if (isRunning) {
        if (confirm('ä»»åŠ¡æ­£åœ¨è¿è¡Œä¸­ï¼Œç¡®å®šè¦è¿”å›å—ï¼Ÿ')) {
          stopTask();
          stopPreview();
          window.location.href = '/';
        }
      } else {
        stopPreview();
        window.location.href = '/';
      }
    }
    
    // å¤„ç†å›è½¦é”®å‘é€è¾“å…¥
    document.getElementById('input-field').addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        sendInput();
      }
    });
    
    // ç§»é™¤ç¼©æ”¾äº‹ä»¶ç›‘å¬ï¼ˆæ”¹ç”¨å…¨å±é¢„è§ˆï¼‰
    
    // FPSå˜åŒ–æ—¶é‡æ–°å¯åŠ¨é¢„è§ˆ
    document.getElementById('previewFps').addEventListener('change', function() {
      if (previewInterval) {
        startPreview();
      }
    });

    // å…¨å±é¢„è§ˆï¼ˆEsc é€€å‡ºç”±æµè§ˆå™¨åŸç”Ÿå¤„ç†ï¼‰
    document.getElementById('btnPageFullscreen').addEventListener('click', async () => {
      try {
        const container = document.querySelector('.preview-container');
        const img = document.getElementById('previewImg');
        // ä¼˜å…ˆè®©å›¾ç‰‡å…ƒç´ è¿›å…¥å…¨å±ä»¥é¿å…å®¹å™¨æ»šåŠ¨åŒºåŸŸå¯¼è‡´çš„é»‘è¾¹/é»‘å±
        const target = img || container || document.documentElement;
        if (target.requestFullscreen) await target.requestFullscreen();
      } catch {}
    });

    // å»¶è¿Ÿæ˜¾ç¤ºï¼ˆç®¡ç†å‘˜ï¼‰
    (function initLatencyDisplay(){
      const delayHeader = document.getElementById('delayHeader');
      if (!delayHeader) return;
      async function measureOnce(){
        const t0 = performance.now();
        try { await fetch('/api/preview/ping?_=' + Date.now(), { cache:'no-cache' }); } catch {}
        const t1 = performance.now();
        const rtt = Math.max(0, Math.round(t1 - t0));
        delayHeader.textContent = ' å»¶è¿Ÿï¼š' + rtt + ' ms';
        delayHeader.style.display = '';
      }
      measureOnce();
      setInterval(measureOnce, 1000);
    })();

    // ---- è¿œç¨‹é¼ æ ‡ä¸é”®ç›˜ ----
    // æ™®é€šç”¨æˆ·éªŒè¯è¿œç¨‹é¼ æ ‡å¯†ç 
    (function initUserMouseVerify(){
      const input = document.getElementById('userControlPassword');
      if (!input) return;
      input.addEventListener('keydown', async (e) => {
        if (e.key !== 'Enter') return;
        const pw = (input.value || '').trim();
        if (!pw) return;
        try {
          const r = await fetch('/api/remote_control/verify', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ password: pw })});
          const j = await r.json();
          if (r.ok && j && j.ok) {
            const enable = document.getElementById('enableRemoteClick');
            if (enable) enable.disabled = false;
            alert('è¿œç¨‹é¼ æ ‡å·²å¯ç”¨');
          } else {
            alert('éªŒè¯å¤±è´¥ï¼š' + (j && j.error));
          }
        } catch {}
      });
    })();

    // é¢„è§ˆå›¾ç‚¹å‡»å‘é€ï¼ˆç®¡ç†å‘˜æˆ–å·²å¯ç”¨è¿œç¨‹é¼ æ ‡çš„æ™®é€šç”¨æˆ·ï¼‰
    (function initPreviewClick(){
      const img = document.getElementById('previewImg');
      const enable = document.getElementById('enableRemoteClick');
      if (!img || !enable) return;
      img.addEventListener('click', async (e) => {
        if (!enable.checked) return;
        const rect = img.getBoundingClientRect();
        const xNorm = rect.width > 0 ? (e.clientX - rect.left) / rect.width : 0;
        const yNorm = rect.height > 0 ? (e.clientY - rect.top) / rect.height : 0;
        try {
          const res = await fetch('/api/input/mouse_click_screen', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ x_norm: xNorm, y_norm: yNorm, button: 'left' })});
          if (!res.ok) {
            try { const t = await res.text(); console.log('mouse_click_screen error:', t); } catch {}
          }
        } catch (err) { console.log('mouse click error', err); }
      });
      // å³é”®èœå• -> å³é”®å•å‡»
      img.addEventListener('contextmenu', async (e) => {
        if (!enable.checked) return;
        e.preventDefault();
        const rect = img.getBoundingClientRect();
        const xNorm = rect.width > 0 ? (e.clientX - rect.left) / rect.width : 0;
        const yNorm = rect.height > 0 ? (e.clientY - rect.top) / rect.height : 0;
        try {
          const res = await fetch('/api/input/mouse_click_screen', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ x_norm: xNorm, y_norm: yNorm, button: 'right' })});
          if (!res.ok) {
            try { const t = await res.text(); console.log('mouse_right error:', t); } catch {}
          }
        } catch {}
      });
      // åŒå‡»
      img.addEventListener('dblclick', async (e) => {
        if (!enable.checked) return;
        const rect = img.getBoundingClientRect();
        const xNorm = rect.width > 0 ? (e.clientX - rect.left) / rect.width : 0;
        const yNorm = rect.height > 0 ? (e.clientY - rect.top) / rect.height : 0;
        try {
          const res = await fetch('/api/input/mouse_double_click', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ x_norm: xNorm, y_norm: yNorm, button: 'left' })});
          if (!res.ok) {
            try { const t = await res.text(); console.log('mouse_dbl error:', t); } catch {}
          }
        } catch {}
      });
    })();

    // é¼ æ ‡æ»šè½®
    (function initWheel(){
      const img = document.getElementById('previewImg');
      const enable = document.getElementById('enableRemoteClick');
      if (!img || !enable) return;
      img.addEventListener('wheel', async (e) => {
        if (!enable.checked) return;
        e.preventDefault();
        const delta = e.deltaY < 0 ? 120 : -120; // ä¸Šæ»šä¸ºæ­£
        try { await fetch('/api/input/mouse_wheel', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ delta })}); } catch {}
      }, { passive: false });
    })();

    // é”®ç›˜æ§åˆ¶ï¼ˆç®¡ç†å‘˜å‹¾é€‰å¯ç”¨ï¼‰
    (function initKeyboard(){
      const enableKb = document.getElementById('enableRemoteKeyboard');
      if (!enableKb) return;
      let active = false;
      enableKb.addEventListener('change', (e) => { active = !!enableKb.checked; });
      document.addEventListener('keydown', (e) => sendKey(e, 'down'));
      document.addEventListener('keyup', (e) => sendKey(e, 'up'));
      async function sendKey(e, action){
        if (!active) return;
        // åŸºæœ¬æ˜ å°„ï¼šæŠŠ e.code ç›´æ¥ä¼ åç«¯ï¼Œç”±åç«¯åšæ›´ç»†æ˜ å°„
        const payload = { key: e.key, code: e.code, action: action, modifiers: [] };
        if (e.ctrlKey) payload.modifiers.push('ctrl');
        if (e.altKey) payload.modifiers.push('alt');
        if (e.shiftKey) payload.modifiers.push('shift');
        if (e.metaKey) payload.modifiers.push('win');
        try { await fetch('/api/input/keyboard_key', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) }); } catch {}
        // é˜²æ­¢é¡µé¢æ»šåŠ¨/å¿«æ·é”®å¹²æ‰°
        e.preventDefault();
        e.stopPropagation();
      }
    })();
    
    // é¡µé¢å¸è½½æ—¶åœæ­¢ä»»åŠ¡å’Œé¢„è§ˆ
    window.addEventListener('beforeunload', function() {
      if (isRunning && currentRunId) {
        fetch('/api/run/stop', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ run_id: currentRunId })
        });
      }
      stopPreview();
    });
  </script>
</body>
</html>
