<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <title>è‡ªå®šä¹‰åŸç†å›¾è®¾è®¡ - åŸç†å›¾ç¼–è¾‘å™¨</title>
  <style>
    :root { color-scheme: light; }
    html, body { height: 100%; margin: 0; padding: 0; }
    body { 
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Helvetica Neue', 'Microsoft YaHei', Arial, sans-serif; 
      background: linear-gradient(135deg, #f5f5f5 0%, #e8e8e8 100%); 
      color: #1a1a1a; 
      display: flex;
      flex-direction: column;
    }
    
    .header {
      background: #ffffff;
      border-bottom: 1px solid #d0d0d0;
      padding: 20px 0;
      text-align: center;
      position: relative;
    }
    
    .back-btn {
      position: absolute;
      left: 20px;
      top: 50%;
      transform: translateY(-50%);
      background: transparent;
      color: #1a1a1a;
      border: 1px solid #d0d0d0;
      padding: 10px 20px;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }
    
    .back-btn:hover {
      background: #f5f5f5;
      border-color: #999999;
      transform: translateY(-50%) translateY(-1px);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }
    
    .header h1 {
      margin: 0;
      font-size: 2.5em;
      background: linear-gradient(135deg, #3a86ff, #7a5cff);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    
    .header p {
      margin: 10px 0 0 0;
      color: #666666;
      font-size: 1.1em;
    }
    
    .main-content {
      flex: 1;
      display: flex;
      flex-direction: column;
      padding: 20px;
      max-width: 1400px;
      margin: 0 auto;
      width: 100%;
      gap: 20px;
    }
    
    .editor-panel {
      background: #ffffff;
      border: 1px solid #d0d0d0;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      flex: 1;
      display: flex;
      flex-direction: column;
    }
    
    .editor-toolbar {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 1px solid #e0e0e0;
      flex-wrap: wrap;
      align-items: center;
    }
    
    .toolbar-title {
      font-size: 1.2em;
      font-weight: 600;
      color: #1a1a1a;
      margin-right: auto;
    }
    
    .editor-btn {
      background: transparent;
      color: #1a1a1a;
      border: 1px solid #d0d0d0;
      padding: 10px 20px;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      font-size: 14px;
    }
    
    .editor-btn:hover {
      background: #f5f5f5;
      border-color: #999999;
      transform: translateY(-1px);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }
    
    .editor-btn:disabled {
      background: #f5f5f5;
      color: #999;
      border-color: #e0e0e0;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }
    
    .editor-content {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 15px;
    }
    
    .file-info-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 15px;
      background: #f5f5f5;
      border-radius: 8px;
      font-size: 0.9em;
      color: #666;
    }
    
    .file-path {
      font-family: 'Consolas', 'Monaco', monospace;
      color: #1976d2;
    }
    
    .schematic-editor-area {
      flex: 1;
      background: #fafafa;
      border: 1px solid #e0e0e0;
      border-radius: 8px;
      padding: 0;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }
    
    .editor-textarea {
      flex: 1;
      width: 100%;
      font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
      font-size: 13px;
      line-height: 1.5;
      padding: 15px;
      border: none;
      background-color: #1e1e1e;
      color: #d4d4d4;
      resize: none;
      outline: none;
    }
    
    .output-log {
      background: #1e1e1e;
      color: #d4d4d4;
      border-radius: 8px;
      padding: 15px;
      font-family: 'Consolas', 'Monaco', monospace;
      font-size: 13px;
      max-height: 200px;
      overflow-y: auto;
      line-height: 1.5;
    }
    
    .output-log .log-success { color: #4caf50; }
    .output-log .log-error { color: #f44336; }
    .output-log .log-warning { color: #ff9800; }
    .output-log .log-info { color: #2196f3; }
    
    .status-bar {
      background: #f5f5f5;
      border-top: 1px solid #d0d0d0;
      padding: 10px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 0.9em;
      color: #666;
    }
    
    .status-indicator {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .status-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: #4caf50;
      animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    /* åŠ è½½æç¤º */
    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 9999;
    }
    
    .loading-overlay.active {
      display: flex;
    }
    
    .loading-content {
      background: white;
      padding: 30px;
      border-radius: 12px;
      text-align: center;
    }
    
    .spinner {
      border: 4px solid #f3f3f3;
      border-top: 4px solid #1976d2;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 0 auto 15px auto;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <div class="header">
    <a href="/run?task=eda" class="back-btn">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M19 12H5M12 19l-7-7 7-7"/>
      </svg>
      è¿”å›åŠŸèƒ½é€‰æ‹©
    </a>
    <h1>ğŸ”§ è‡ªå®šä¹‰åŸç†å›¾è®¾è®¡</h1>
    <p>è‡ªå®šä¹‰æ‹“æ‰‘åŸç†å›¾/PCBè®¾è®¡ç¼–è¾‘å™¨</p>
  </div>

  <div class="main-content">
    <!-- ç¼–è¾‘å™¨é¢æ¿ -->
    <div class="editor-panel">
      <div class="editor-toolbar">
        <div class="toolbar-title">ğŸ“ åŸç†å›¾æ–‡ä»¶ç¼–è¾‘å™¨</div>
        <button class="editor-btn" onclick="getSchematicCode()">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="display: inline; vertical-align: middle; margin-right: 5px;">
            <polyline points="16 18 22 12 16 6"/>
            <polyline points="8 6 2 12 8 18"/>
          </svg>
          åŸç†å›¾ä»£ç è·å–
        </button>
        <button class="editor-btn" onclick="openKicad()">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="display: inline; vertical-align: middle; margin-right: 5px;">
            <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
            <line x1="9" y1="9" x2="15" y2="9"/>
            <line x1="9" y1="15" x2="15" y2="15"/>
          </svg>
          æ‰“å¼€KiCad
        </button>
        <button class="editor-btn" onclick="openSchematicEditor()">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="display: inline; vertical-align: middle; margin-right: 5px;">
            <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
            <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
          </svg>
          æ‰“å¼€åŸç†å›¾ç¼–è¾‘å™¨
        </button>
        <button class="editor-btn" onclick="saveSchematic()" id="saveBtn">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="display: inline; vertical-align: middle; margin-right: 5px;">
            <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/>
            <polyline points="17 21 17 13 7 13 7 21"/>
            <polyline points="7 3 7 8 15 8"/>
          </svg>
          ä¿å­˜æ–‡ä»¶
        </button>
      </div>

      <div class="file-info-bar">
        <div>
          <span>æ–‡ä»¶: </span>
          <span class="file-path" id="filePath">Self_Design.kicad_sch</span>
        </div>
        <div id="fileStats">åŠ è½½ä¸­...</div>
      </div>

      <div class="editor-content">
        <div class="schematic-editor-area">
          <textarea class="editor-textarea" id="schematicContent" placeholder="æ­£åœ¨åŠ è½½åŸç†å›¾æ–‡ä»¶..."></textarea>
        </div>

        <!-- è¾“å‡ºæ—¥å¿— -->
        <div class="output-log" id="outputLog">
          <div class="log-info">â³ æ­£åœ¨åŠ è½½åŸç†å›¾æ–‡ä»¶...</div>
        </div>
      </div>
    </div>
  </div>

  <div class="status-bar">
    <div class="status-indicator">
      <div class="status-dot"></div>
      <span id="statusText">ç¼–è¾‘å™¨åˆå§‹åŒ–ä¸­...</span>
    </div>
    <div>
      <span>é¡¹ç›®è·¯å¾„: EDA/Self_Design/</span>
    </div>
  </div>

  <!-- åŠ è½½æç¤º -->
  <div class="loading-overlay" id="loadingOverlay">
    <div class="loading-content">
      <div class="spinner"></div>
      <div id="loadingText">å¤„ç†ä¸­...</div>
    </div>
  </div>

  <script>
    let originalContent = '';
    let isModified = false;

    function addLog(message, type = 'info') {
      const log = document.getElementById('outputLog');
      const logEntry = document.createElement('div');
      logEntry.className = `log-${type}`;
      logEntry.textContent = message;
      log.appendChild(logEntry);
      log.scrollTop = log.scrollHeight;
    }

    function updateStatus(text) {
      document.getElementById('statusText').textContent = text;
    }

    function updateFileStats(content) {
      const lines = content.split('\n').length;
      const size = new Blob([content]).size;
      const sizeKB = (size / 1024).toFixed(1);
      const modified = isModified ? ' | âœ å·²ä¿®æ”¹' : '';
      document.getElementById('fileStats').textContent = `${lines} è¡Œ | ${sizeKB} KB${modified}`;
    }

    // è·³è½¬åˆ°åŸç†å›¾ä»£ç è·å–é¡µé¢
    function getSchematicCode() {
      addLog('ğŸ”— æ­£åœ¨è·³è½¬åˆ°åŸç†å›¾ä»£ç è·å–å·¥å…·...', 'info');
      window.open('https://www.coze.cn/space/7546496844034162739/ui-builder-preview/7546449200230367284/pc/VA2TnF9bon', '_blank');
      addLog('âœ“ å·²åœ¨æ–°æ ‡ç­¾é¡µä¸­æ‰“å¼€ä»£ç è·å–å·¥å…·', 'success');
    }

    function showLoading(text = 'å¤„ç†ä¸­...') {
      document.getElementById('loadingText').textContent = text;
      document.getElementById('loadingOverlay').classList.add('active');
    }

    function hideLoading() {
      document.getElementById('loadingOverlay').classList.remove('active');
    }

    // ç›‘å¬æ–‡æœ¬å˜åŒ–
    document.addEventListener('DOMContentLoaded', function() {
      const textarea = document.getElementById('schematicContent');
      textarea.addEventListener('input', function() {
        if (textarea.value !== originalContent) {
          isModified = true;
          updateFileStats(textarea.value);
        } else {
          isModified = false;
          updateFileStats(textarea.value);
        }
      });
    });

    // åŠ è½½åŸç†å›¾æ–‡ä»¶
    async function loadSchematic() {
      try {
        addLog('ğŸ“„ æ­£åœ¨è¯»å–è‡ªå®šä¹‰åŸç†å›¾æ–‡ä»¶...', 'info');
        
        const response = await fetch('/api/eda/get_custom_schematic_content', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({})
        });
        
        const result = await response.json();
        
        if (result.status === 'success') {
          originalContent = result.content;
          document.getElementById('schematicContent').value = result.content;
          updateFileStats(result.content);
          addLog('âœ“ è‡ªå®šä¹‰åŸç†å›¾æ–‡ä»¶åŠ è½½æˆåŠŸ', 'success');
          addLog(`âœ“ æ–‡ä»¶è·¯å¾„: ${result.file_path}`, 'info');
          updateStatus('ç¼–è¾‘å™¨å°±ç»ª');
        } else {
          addLog(`âœ— åŠ è½½å¤±è´¥: ${result.error}`, 'error');
          updateStatus('åŠ è½½å¤±è´¥');
        }
      } catch (err) {
        addLog(`âœ— è¯·æ±‚å¤±è´¥: ${err.message}`, 'error');
        updateStatus('åŠ è½½å¤±è´¥');
      }
    }

    // æ‰“å¼€KiCadï¼ˆæ‰“å¼€Self_Designé¡¹ç›®ï¼‰
    async function openKicad() {
      addLog('ğŸš€ æ­£åœ¨å¯åŠ¨KiCadè½¯ä»¶ï¼ˆSelf_Designé¡¹ç›®ï¼‰...', 'info');
      showLoading('æ­£åœ¨æ‰“å¼€KiCad...');
      
      try {
        const response = await fetch('/api/eda/open_custom_kicad', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({})
        });
        
        const result = await response.json();
        hideLoading();
        
        if (result.status === 'success') {
          addLog('âœ“ KiCadè½¯ä»¶å·²æ‰“å¼€ï¼ˆSelf_Designé¡¹ç›®ï¼‰', 'success');
          addLog(`âœ“ é¡¹ç›®è·¯å¾„: ${result.project_path}`, 'info');
        } else {
          addLog(`âœ— æ‰“å¼€å¤±è´¥: ${result.error}`, 'error');
        }
      } catch (err) {
        hideLoading();
        addLog(`âœ— è¯·æ±‚å¤±è´¥: ${err.message}`, 'error');
      }
    }

    // æ‰“å¼€åŸç†å›¾ç¼–è¾‘å™¨ï¼ˆåªæ‰“å¼€eeschemaï¼ŒSelf_Designé¡¹ç›®ï¼‰
    async function openSchematicEditor() {
      addLog('ğŸ“ æ­£åœ¨æ‰“å¼€åŸç†å›¾ç¼–è¾‘å™¨ï¼ˆSelf_Designï¼‰...', 'info');
      showLoading('æ­£åœ¨æ‰“å¼€åŸç†å›¾ç¼–è¾‘å™¨...');
      
      try {
        const response = await fetch('/api/eda/open_custom_schematic_only', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({})
        });
        
        const result = await response.json();
        hideLoading();
        
        if (result.status === 'success') {
          addLog('âœ“ åŸç†å›¾ç¼–è¾‘å™¨å·²æ‰“å¼€ï¼ˆSelf_Designï¼‰', 'success');
          addLog(`âœ“ æ–‡ä»¶è·¯å¾„: ${result.schematic_path}`, 'info');
          addLog('ğŸ’¡ æç¤ºï¼šç¼–è¾‘å™¨çª—å£å·²å…¨å±æ˜¾ç¤º', 'info');
        } else {
          addLog(`âœ— æ‰“å¼€å¤±è´¥: ${result.error}`, 'error');
        }
      } catch (err) {
        hideLoading();
        addLog(`âœ— è¯·æ±‚å¤±è´¥: ${err.message}`, 'error');
      }
    }

    // ä¿å­˜åŸç†å›¾
    async function saveSchematic() {
      const content = document.getElementById('schematicContent').value;
      
      if (!isModified) {
        addLog('â„¹ æ–‡ä»¶æœªä¿®æ”¹ï¼Œæ— éœ€ä¿å­˜', 'info');
        return;
      }
      
      addLog('ğŸ’¾ æ­£åœ¨ä¿å­˜è‡ªå®šä¹‰åŸç†å›¾æ–‡ä»¶...', 'info');
      showLoading('æ­£åœ¨ä¿å­˜æ–‡ä»¶...');
      
      try {
        const response = await fetch('/api/eda/save_custom_schematic_content', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ content: content })
        });
        
        const result = await response.json();
        hideLoading();
        
        if (result.status === 'success') {
          originalContent = content;
          isModified = false;
          updateFileStats(content);
          addLog('âœ“ æ–‡ä»¶ä¿å­˜æˆåŠŸ', 'success');
          addLog(`âœ“ æ–‡ä»¶è·¯å¾„: ${result.file_path}`, 'info');
          addLog(`âœ“ å¤‡ä»½è·¯å¾„: ${result.backup_path}`, 'info');
          addLog('ğŸ’¡ æç¤ºï¼šå¯åœ¨KiCadä¸­é‡æ–°åŠ è½½æ–‡ä»¶æŸ¥çœ‹æ›´æ”¹', 'info');
          alert('âœ“ ä¿å­˜æˆåŠŸï¼\n\næ–‡ä»¶å·²ä¿å­˜ï¼Œå¯åœ¨KiCadä¸­æŸ¥çœ‹æ›´æ”¹ã€‚');
        } else {
          addLog(`âœ— ä¿å­˜å¤±è´¥: ${result.error}`, 'error');
          alert(`ä¿å­˜å¤±è´¥: ${result.error}`);
        }
      } catch (err) {
        hideLoading();
        addLog(`âœ— ä¿å­˜è¯·æ±‚å¤±è´¥: ${err.message}`, 'error');
        alert(`ä¿å­˜è¯·æ±‚å¤±è´¥: ${err.message}`);
      }
    }

    // é¡µé¢åŠ è½½å®Œæˆåè‡ªåŠ¨åŠ è½½æ–‡ä»¶
    window.addEventListener('load', async () => {
      addLog('ğŸ‰ è‡ªå®šä¹‰åŸç†å›¾è®¾è®¡ç¼–è¾‘å™¨åŠ è½½å®Œæˆ', 'success');
      await loadSchematic();
    });

    // ç¦»å¼€é¡µé¢å‰æç¤º
    window.addEventListener('beforeunload', function (e) {
      if (isModified) {
        e.preventDefault();
        e.returnValue = 'æ‚¨æœ‰æœªä¿å­˜çš„æ›´æ”¹ï¼Œç¡®å®šè¦ç¦»å¼€å—ï¼Ÿ';
        return e.returnValue;
      }
    });

    // å¿«æ·é”®æ”¯æŒ
    document.addEventListener('keydown', function(e) {
      // Ctrl+S ä¿å­˜
      if (e.ctrlKey && e.key === 's') {
        e.preventDefault();
        saveSchematic();
      }
    });
  </script>
</body>
</html>

